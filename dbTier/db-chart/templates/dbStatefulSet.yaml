apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ .Values.general.standardName }}-set
spec:
  serviceName: {{ .Values.stateSet.serviceName }}
  replicas: {{ .Values.stateSet.replicas }}
  selector:
    matchLabels:
      {{ .Values.stateSet.labelKey }}: {{ .Values.stateSet.labelValue }}
  template:
    metadata:
      labels:
        {{ .Values.stateSet.labelKey }}: {{ .Values.stateSet.labelValue }}
      # Need this to reload pods when some resources change 
      # TODO Delete this when the template works consistently
      annotations:
        rollme: {{ randAlphaNum 5 | quote }}
    spec:
      containers:
      - name: {{ .Values.stateSet.containerName }}
        image: {{ .Values.stateSet.containerImage }}
        env:
        - name: {{ .Values.db.userKey }}
          valueFrom:
            configMapKeyRef:
              name: {{ .Values.general.standardName }}-config
              key: {{ .Values.db.userKey }}
        - name: {{ .Values.db.pwKey }}
          valueFrom:
            secretKeyRef:
              name: {{ .Values.general.standardName }}-secret
              key: {{ .Values.db.pwKey }}
        ports:
        - containerPort: {{ .Values.stateSet.containerPort }}
          name: {{ .Values.stateSet.containerName }}-port
        volumeMounts:
        - name: {{ .Values.general.standardName }}-data
          mountPath: {{ .Values.stateSet.pvcMountPath }}
      volumes: 
        - name: {{ .Values.general.standardName }}-data
          persistentVolumeClaim:
            claimName: {{ .Values.general.standardName }}-pvc
  # Commenting since the PVC YAML file creates the referred PVC resource
  #volumeClaimTemplates:
  #- metadata:
  #    name: {{ .Values.general.standardName }}-data
  #  spec:
  #    storageClassName: {{ .Values.pvc.storageClassName }}
  #    accessModes: 
  #    - {{ .Values.pvc.accessModes }}
  #    resources:
  #      requests:
  #        storage: {{ .Values.pvc.storage }}